#!/bin/sh

. utils

getmount() {
	mnt="$(echo $1 | prompt "Mount point?")"
	[ ! -d "$mnt" ] && mkdir -p "$mnt"
}

mountdrive() {
	drives="$(lsblk -rpo "name,type,size,mountpoint" | grep 'part\|rom\|crypt' | awk '$4==""{printf "%s (%s)\n",$1,$3}')"
	chosen="$(echo "$drives" | prompt "Mount which drive?")" || exit 1
	chosen="$(echo "$chosen" | awk '{print $1}')"
	getmount "$HOME/mnt$chosen"
	sudo -A mount "$chosen" "$mnt"
	end $?
}

mountssh() {
	host="$(grep -P "^Host ([^*]+)$" $HOME/.ssh/config | sed 's/Host //' | prompt "Mount which host?")" || exit 1
	target="$(echo "" | prompt "Target mount point?")"
	getmount "$HOME/mnt/$host"
	sshfs $host:$target $mnt -o follow_symlinks
	end $?
}

open() {
	key="$(getpass "Drive passphrase or key path: ")" || end 1
	if [ -f "$key" ]; then
		sudo -A cryptsetup open $chosen $name --key-file $key && return 0
	else
		sudo -A cryptsetup open $chosen $name <<< "$key" && return 0
	fi
	open
}

decrypt() {
	if [ -z "$chosen" ]; then
		drives="$(lsblk -rpo "name,size,fstype" | grep "crypto_LUKS" | awk '{printf "%s (%s)\n", $1, $2}')"
		chosen="$(echo "$drives" | prompt "Drive to unlock?")" || exit 1
		chosen="$(echo "$chosen" | awk '{print $1}')"
		name="$(echo "" | prompt "Name: ")"
		getmount "$HOME/mnt/dev/mapper/$name"
	fi

	open
	sudo -A mount "/dev/mapper/$name" "$mnt"
	end $?
}

mountandroid() {
	getmount "$HOME/mnt"
	jmtpfs "$mnt"
	end $?
}

asktype() {
	choice="$(printf "Drive\\nSSH\\nCrypt\\nAndroid" | prompt "Mount:")" || exit 1
	case "$choice" in
		Drive) mountdrive ;;
		SSH) mountssh ;;
		Crypt) decrypt ;;
		Android) mountandroid ;;
	esac
}

end() {
	if [ "$1" -eq 0 ]; then
		notify "Mounting" "Mounted at $mnt"
	else
		notify "Mounting" "Mounting failed!"
		[ -z "$(ls -A $mnt)" ] && rm -rf "$mnt"
	fi
	exit $1
}

if [ -z "$1" ]; then
	asktype
else
	chosen="$1"
	name="a-$(basename $chosen | sed 's/.img//')"
	mnt="$(pwd)/$name"
	[ ! -d "$mnt" ] && mkdir -p "$mnt"
	cryptsetup isLuks "$1" && decrypt $1 "$name"
fi
