#!/bin/sh

getmount() {
	mnt="$(echo $1 | dmenu -i -p "Mount point?")"
	[ ! -d "$mnt" ] && mkdir -p "$mnt"
}

mountusb() {
	usbdrives="$(lsblk -rpo "name,type,size,mountpoint" | grep 'part\|rom\|crypt' | awk '$4==""{printf "%s (%s)\n",$1,$3}')"
	chosen="$(echo "$usbdrives" | dmenu -i -p "Mount which drive?")" || exit 1
	chosen="$(echo "$chosen" | awk '{print $1}')"
	getmount "$HOME/mnt$chosen"
	sudo -A mount "$chosen" "$mnt"
	notify $?
}

mountssh() {
	host="$(grep -P "^Host ([^*]+)$" $HOME/.ssh/config | sed 's/Host //' | dmenu -i -p "Mount which host?")" || exit 1
	target="$(echo "" | dmenu -i -p "Target mount point?")"
	getmount "$HOME/mnt/$host"
	sshfs $host:$target $mnt -o follow_symlinks
	notify $?
}

open() {
	key="$(dmenu -nb "#A54242" -P -p "Drive passphrase or key path: " <&-)" || notify 1
	if [ -f "$key" ]; then
		sudo -A cryptsetup open $chosen $name --key-file $key && return 0
	else
		sudo -A cryptsetup open $chosen $name <<< "$key" && return 0
	fi
	open
}

decrypt() {
	if [ -z "$chosen" ]; then
		drives="$(lsblk -rpo "name,size,fstype" | grep "crypto_LUKS" | awk '{printf "%s (%s)\n", $1, $2}')"
		chosen="$(echo "$drives" |  dmenu -i -p "Drive to unlock?")" || exit 1
		chosen="$(awk '{print $1}' <<< $chosen)"
		name="$(dmenu -p "Name: " <&-)"
		getmount "$HOME/mnt/dev/mapper/$name"
	fi

	open
	sudo -A mount "/dev/mapper/$name" "$mnt"
	notify $?
}

mountandroid() {
	getmount "$HOME/mnt"
	jmtpfs "$mnt"
	notify $?
}

notify() {
	if [ "$1" -eq 0 ]; then
		notify-send "Mounting" "Mounted at $mnt"
	else
		notify-send "Mounting" "Mounting failed!"
		[ -z "$(ls -A $mnt)" ] && rm -rf "$mnt"
	fi
	exit $1
}

asktype() {
	choice="$(printf "USB\\nSSH\\nCrypt\\nAndroid" | dmenu -i -p "Mount:")" || exit 1
	case "$choice" in
		USB) mountusb ;;
		SSH) mountssh ;;
		Crypt) decrypt ;;
		Android) mountandroid ;;
	esac
}

if [ -z "$1" ]; then
	asktype
else
	chosen="$1"
	name="a-$(basename $chosen | sed 's/.img//')"
	mnt="$(pwd)/$name"
	[ ! -d "$mnt" ] && mkdir -p "$mnt"
	cryptsetup isLuks "$1" && decrypt $1 "$name"
fi
