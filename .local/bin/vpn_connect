#!/bin/sh

active=$(nmcli -g name,type c s -a | grep vpn | cut -d ":" -f 1)

connect() {
	[ -n "$active" ] && nmcli c d $active
	vpnlist=$(nmcli -g name,type c s | grep :vpn | cut -d ":" -f 1)
	name=$(dmenu -p "Connect: " <<< $vpnlist)
	[ $? -ne 0 ] && exit 0
	uuid=$(nmcli -g connection.uuid c s $name)
	key=$(secret-tool lookup connection-uuid $uuid)

	if [ -n "$key" ]; then
		tmp=$(mktemp)
		chmod 600 $tmp
		printf "vpn.secrets.password:$key" > $tmp
		nmcli c u $uuid passwd-file $tmp
		rm $tmp
	else
		nmcli c u $uuid
	fi
	[ $? -eq 0 ] && notify-send "VPN" "Successfully activated" || notify-send -u "critical" "VPN" "Connection failed"
}

disconnect() {
	nmcli c d $active && notify-send "VPN" "Successfully deactivated" || notify-send -u "critical" "VPN" "Disconnection failed"
}

[ -z $1 ] && connect || disconnect
