#!/bin/sh

MSG="$([ -f .git/MERGE_MSG ] && cat .git/MERGE_MSG || echo "")"
[[ $MSG == [M\|m]erge* ]] && exit 0
stagedFiles="$(git diff --cached --name-only)"

validate() {
	echo "$2" | grep -Pq "$3" && matches+="$1: $2\n"
}

result=""
for file in $stagedFiles; do
	matches=""
	while IFS= read -r line; do
		validate 'Trailing whitespaces ' "$line" '\s$'
		validate 'Multiple spaces      ' "$line" '\S[ ]{2,}\S'
		validate 'Mixed indentation    ' "$line" '\t | \t'
		[[ $file = *.xml ]] && validate 'Bad spacing around = ' "$line" '( =|= )'
		[[ $file != *.brs ]] && continue
		validate 'If not having then   ' "$line" '(?!.*then)^\s*(else )?if.*$'
		validate 'No output type       ' "$line" 'function \w*\(.*\)(?! as \w.*)'
		validate 'No input type        ' "$line" '(sub|function)\s+\w+\((?!(?:\s*\w+\s+(.*?)as\s+\w+(?:\s*,\s*\w+\s+(.*?)as\s+\w+)*)?\s*\))'
	done <<< "$(git diff --cached "$file" | grep -Po '^\+\K.*')"

	[ -n "$matches" ] && result+="FILE                 : $file\n$matches"
done

[ -n "$result" ] && echo -e "$result" && exit 1
exit 0
