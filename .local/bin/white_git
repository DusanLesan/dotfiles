#!/bin/sh

MSG="$([ -f .git/MERGE_MSG ] && cat .git/MERGE_MSG || echo "")"
[[ $MSG == [M\|m]erge* ]] && exit 0
stagedFiles="$(git diff --cached --name-only)"

validate() {
	IFS=':' read -r number code <<< "$2"
	echo "$code" | grep -Pq "$3" && matches+="$1: $number: $code\n"
}

enumerate() {
	awk 'match($0,"^@@ -([0-9]+),([0-9]+) [+]([0-9]+),([0-9]+) @@", header){ number=header[3] }
		/^(---|\+\+\+|[^-+ ])|^[-]/ { next }
		/^[+]/ { printf "%s:%s\n", number, substr($0, 2) }
		{ number++ }'
}

result=""
for file in $stagedFiles; do
	matches=""
	while IFS= read -r line; do
		validate 'Trailing whitespaces ' "$line" '\s$'
		validate 'Multiple spaces      ' "$line" '\S[ ]{2,}\S'
		validate 'Mixed indentation    ' "$line" '\t | \t'
		[[ $file = *.xml ]] && validate 'Bad spacing around = ' "$line" '( =|= )'
		[[ $file != *.brs ]] && continue
		validate 'If not having then   ' "$line" '(?!.*then)^\s*(else )?if.*$'
		validate 'No output type       ' "$line" 'function \w*\(.*\)(?! as \w.*)'
		validate 'No input type        ' "$line" '(sub|function)\s+\w+\((?!(?:\s*\w+\s+(.*?)as\s+\w+(?:\s*,\s*\w+\s+(.*?)as\s+\w+)*)?\s*\))'
	done <<< "$(git diff --cached "$file" | enumerate )"

	[ -n "$matches" ] && result+="FILE                 : $file\n$matches"
done

[ -n "$result" ] && echo -e "$result" && exit 1
exit 0
