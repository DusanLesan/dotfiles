#!/bin/sh

connect() {
	ip link show up | grep -q "tun" && sudo kill-openvpn

	vpnlist=$(ls ~/.local/share/ovpn | sed -e 's/\..*$//' )
	name=$(dmenu -p "Connect: " <<< $vpnlist)
	[ $? -ne 0 ] && exit 0

	pass=$(secret-tool lookup pass $name)
	user=$(secret-tool lookup user $name)

	tmp=$(mktemp)
	chmod 600 $tmp
	echo "$user" > $tmp
	echo "$pass" >> $tmp
	sudo openvpn --config ~/.local/share/ovpn/$name.ovpn --auth-user-pass $tmp
	connected=$?
	rm $tmp
	[ $connected -eq 0 ] && myip || notify-send -u "critical" "VPN" "Connection failed"
}

disconnect() {
	ip link show up | grep -q "tun" && sudo kill-openvpn || notify-send -u "critical" "VPN" "Disconnection failed"
}

[ -z $1 ] && connect || disconnect
