#!/bin/sh

sudo -A iptables -F
sudo -A iptables -X
sudo -A iptables -t nat -F
sudo -A iptables -t nat -X
sudo -A iptables -t mangle -F
sudo -A iptables -t mangle -X

sudo -A iptables -A INPUT -i lo -j ACCEPT
sudo -A iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo -A iptables -A INPUT -p tcp -m tcp --dport 5622 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --name DEFAULT --mask 255.255.255.255 --rsource -j DROP
sudo -A iptables -A INPUT -p tcp -m tcp --dport 5622 -m state --state NEW -m recent --set --name DEFAULT --mask 255.255.255.255 --rsource
sudo -A iptables -A INPUT -p tcp -m tcp --dport 5622 -m state --state NEW -j ACCEPT
sudo -A iptables -A INPUT -p udp --dport 67 -s 0.0.0.0 -j ACCEPT
sudo -A iptables -A INPUT -j DROP
sudo -A iptables -A FORWARD -s 10.42.0.0/24 -j ACCEPT
sudo -A iptables -A FORWARD -d 10.42.0.0/24 -j ACCEPT
sudo -A iptables -A OUTPUT -o lo -j ACCEPT
sudo -A iptables -A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT

if [ "$1" = "log" ]; then
	sudo iptables -I INPUT 1 -m limit --limit 1/m -j LOG --log-prefix="iptables: dropped packets I: " --log-level 4
	sudo iptables -I OUTPUT 1 -m limit --limit 1/m -j LOG --log-prefix="iptables: dropped packets O: " --log-level 4
	sudo iptables -I FORWARD 1 -m limit --limit 1/m -j LOG --log-prefix="iptables: dropped packets F: " --log-level 4
fi

sudo -A iptables -nL
