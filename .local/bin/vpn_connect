#!/bin/sh

. utils

connect() {
	ip link show up | grep -q "tun" && sudo kill_task openvpn

	vpnlist=$(ls ~/.local/share/ovpn | sed -e 's/\..*$//' )
	name=$(prompt "Connect: " <<< "$vpnlist") || exit 0
	pass=$(secret-tool lookup pass "$name")
	user=$(secret-tool lookup user "$name")

	tmp=$(mktemp)
	chmod 600 $tmp
	echo "$user"$'\n'"$pass" > $tmp
	sudo openvpn --daemon --config ~/.local/share/ovpn/$name.ovpn --auth-user-pass $tmp
	[ $? -ne 0 ] && notify-send -u "critical" "VPN" "Connection failed"
	rm $tmp
	wait "ip link show up | grep -q 'tun'"
}

disconnect() {
	ip link show up | grep -q "tun" && sudo kill_task openvpn || notify-send -u "critical" "VPN" "Disconnection failed"
	wait "ping -c 1 8.8.8.8 -W 1 > /dev/null"
}

[ -z $1 ] && connect || disconnect
myip
