#!/bin/sh

. utils

datadir="$HOME/.config/BraveSoftware/Brave-Browser/Default"

if [ -z "$1" ]; then
	browser=$BROWSER
else
	browser=$(prompt "Choose browser:" $'firefox\nlibrewolf\nbrave') || exit
	if pgrep -x "$browser" >/dev/null; then
		[ "$(prompt 'Open in new window?' $'yes\nno')" = "yes" ] && browser="$browser --new-window"
	fi
fi

getUrl() {
	chosen="$(prompt "Search:" "$(jq -r '.name' <<< $children)")" || exit
	selected="$(jq 'select(.name == "'"$chosen"'")' <<< $children)"

	if [ "$chosen" = "s" ] || [ "$chosen" = "search" ]; then
		searches=$(sqlite3 "file:$datadir/Web Data?mode=ro&nolock=1" \
			"SELECT short_name, url FROM keywords WHERE usage_count > 0;")
		search_short=$(prompt "Choose search engine:" "$(printf '%s\n' "$searches" | cut -d'|' -f1)") || exit
		search_term=$(prompt "Enter search term:") || exit
		url=$(printf '%s\n' "$searches" | awk -F'|' -v se="$search_short" -v term="$search_term" \
			'$1 == se {gsub(/\{searchTerms\}/, term, $2); print $2}')
	elif jq -e 'select(.children != null)' <<< "$selected" > /dev/null; then
		children=$(jq "$jqQuery" <<< "$selected" 2>/dev/null)
		getUrl
	else
		url="$(jq -r '.url' <<< "$selected")"
	fi
}

jqQuery='.children[]? | {name: .name, url: .url, children: .children}'
children=$(jq ".roots[] | $jqQuery" "$datadir/Bookmarks" 2>/dev/null)

getUrl

$browser "$url" >/dev/null 2>&1 &
