#!/bin/sh

export SUDO_ASKPASS="$HOME/.local/bin/askpass"
interface=$(nmcli device status | grep "wifi\s*connected" | cut -d " " -f 1)
bandwidth=200
unit=kbit

function getInfo {
	ACTION=$(prompt "Add rule\nChange rule\nDelete rule" "Action")
	[ "$ACTION" = "Delete rule" ] && return 0
	OPTION=$(prompt "Default values($bandwidth$unit @ $interface)\nChange values" "Set values")
	if [ "$OPTION" = "Change values" ]; then
		interface=$(prompt "$interface" "Interface name")
		bandwidth=$(prompt "$bandwidth" "Bandwith in $unit")
	fi
}

function prompt {
	[ -x "$(command -v dmenu)" ] && [ x$DISPLAY != x ] && echo $(promptDmenu "$1" "$2")
}

function promptDmenu {
	result=$(printf "$1" | dmenu -i -p "$2: ")
	[ $? -eq 1 ] && kill $$
	echo "$result"
}

function help {
	echo "$(basename $0) -i interface (default: $interface)" >&2
	echo "$(basename $0) -b bandwidth (default: $bandwidth)" >&2
	echo "$(basename $0) -u unit (default: $unit)" >&2
	echo "$(basename $0) -a add rule" >&2
	echo "$(basename $0) -c change rule" >&2
	echo "$(basename $0) -d delete rule" >&2
	echo "One of these flags must be included (a,c,d)"
	exit 1
}

while getopts 'acdi:b:u:' OPTION; do
	case "$OPTION" in
		i) interface=$OPTARG ;;
		b) bandwidth=$OPTARG ;;
		u) unit=$OPTARG ;;
		a) ACTION="Add rule" ;;
		c) ACTION="Change rule" ;;
		d) ACTION="Delete rule" ;;
		?) help; kill $$ ;;
	esac
done

[ -z "$ACTION" ] && getInfo

case "$ACTION" in
	"Add rule") action="add" ;;
	"Change rule") action="change" ;;
	"Delete rule") action="delete" ;;
	*) help ;;
esac

sudo -A tc qdisc $action dev $interface root tbf rate $bandwidth$unit latency 50ms burst 1540
