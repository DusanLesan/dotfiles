#!/bin/sh

assignee="DusanLesan"
[ -x "$(command -v dmenu)" ] && cmd="dmenu -p" || cmd="fzf --bind=ctrl-space:print-query --prompt"
[ -z "$1" ] && branch="$(git branch --show-current)" || branch="$1"
ticketNumber=$(echo $branch | grep -Eo "ROKU-[[:digit:]]*")
ticketName=$(echo $branch | sed 's/.*ROKU-[[:digit:]]*\///' | tr '_' ' ')
mkdir -p /tmp/gh
gh listLabels > /tmp/gh/labels &
gh listMilestones > /tmp/gh/milestones &

getBase() {
	base=$(git branch --sort=-committerdate | sed -e 's/^*//' -e 's/^ *//' | $cmd "Base branch: " | sed 's/ //g')
	[ -z "$base" ] && exit 1
}

getTitlesAndDescription() {
	titles=("$ticketName")
	[ -z "$ticketNumber" ] && return 0
	while IFS= read -r line; do
		codes="$codes[$line]"
		body="$body\n[$line](https:\/\/plutotv.atlassian.net\/browse\/$line)"
	done <<< "$ticketNumber"
	titles=("$codes $ticketName" "${titles[@]}")
	body="$(printf "$body" | sed -E 's/^\n//')"
}

getLabels() {
	if [ -z "$labelList" ]; then
		[ -f /tmp/gh/labels ] && labelList=$(cat /tmp/gh/labels ) || labelList=$(gh listLabels)
	fi
	[ -z "$labelList" ] && return 0
	label=$(echo "$labelList" | $cmd "Label: ")
	[ $? -ne 0 ] && return 1
	labelList=$(echo "$labelList" | sed "/$label/d")
	[ -n "$labels" ] && [ -n "$label" ] && labels="$labels,$label" || labels="$label"
	getLabels
}

getReviewers() {
	reviewers="$(cat ~/.local/share/team_dev | tr '\n' ',' | sed 's/,$//')"
	[[ "$labels" != *"dev-approval-only"* ]] && reviewers="$reviewers,$(cat ~/.local/share/team_ste | tr '\n' ',' )"
	reviewers="$(printf "$reviewers" | sed 's/,$//')"
}

getMilestone() {
	[ -f /tmp/gh/milestones ] && milestoneList=$(cat /tmp/gh/milestones ) || milestoneList=$(gh listMilestones)
	[ -n "$milestoneList" ] && milestone=$(echo "$milestoneList" | $cmd "Milestone:")
}

getBase
getTitlesAndDescription
getLabels
getReviewers
getMilestone
title=$(printf '%s\n' "${titles[@]}" | $cmd "PR title:")
retVal=$? && [ $retVal -eq 1 ] && exit 1
gh pr create -t "$title" -B "$base" -H "$branch" -a "$assignee" -r "$reviewers" -b "$body" -l "$labels" -m "$milestone"
